---
title: "Graficas de dia de la elecci√≥n"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
```

```{r,echo=FALSE,message=FALSE}
candidatos <- read_csv("../data-raw/estados_candidatos_partidos_2023.csv") |>
  mutate(CANDIDATO = ifelse(PARTIDO == "NULOS", "NULOS", CANDIDATO)) |>
  mutate(CANDIDATO = ifelse(PARTIDO == "CNR", "CNR", CANDIDATO))
```

```{r, warning=FALSE, include=FALSE}
ruta_buzon <- "/workspaces/docker-conteo-2023/servidorine/buzon/"
get_df <- function(edo_no, edo_nombre){
  get_fdate <- function(x){
    x <- as.character(x)
    nx <- as.POSIXct(paste0(substr(x,1,2)," ",substr(x,3,4),":",substr(x,5,6)),format = "%d %H:%M")
  }
    cands <- candidatos |> filter(ID_ESTADO == edo_no, !CANDIDATO %in% c("NULOS", "CNR")) |>
      pull(CANDIDATO) |> 
      unique()
    archivos <- list.files(paste0(ruta_buzon, edo_nombre), pattern = "*csv")
    romero_archivos <- paste0(ruta_buzon, edo_nombre, "/", archivos[grepl("romero", archivos, fixed = TRUE)])
    ortiz_archivos <- paste0(ruta_buzon, edo_nombre, "/", archivos[grepl("ortiz", archivos, fixed = TRUE)])
    rodriguez_archivos <- paste0(ruta_buzon, edo_nombre, "/", archivos[grepl("rodriguez", archivos, fixed = TRUE)])
    romero <-  map_df(romero_archivos, ~ read_csv(.) |>
                     mutate_at(vars(EN), ~as.character(.)) |>
                     mutate(method="romero"))
    ortiz <-  map_df(ortiz_archivos, ~ read_csv(.) |>
                     mutate_at(vars(EN), ~as.character(.)) |>
                     mutate(method="ortiz"))
    rodriguez <-  map_df(rodriguez_archivos, ~ read_csv(.) |>
                     mutate_at(vars(EN), ~as.character(.)) |>
                     mutate(method="rodriguez"))
    df <- do.call("rbind", list(romero, ortiz, rodriguez)) |>
      pivot_longer(cols = all_of(c(cands, "PART")), names_to = "candidato", values_to = "porcentaje") |>
      rename(fecha = R) |>
      mutate_at(vars(fecha), get_fdate) |>
      mutate(LMU = dplyr::case_when(
        LMU == 0 ~ "inf",
        LMU == 1 ~ "median",
        LMU == 2 ~ "sup")) |>
      group_by(EQ, EN, fecha) |>
      pivot_wider(names_from = LMU, values_from = porcentaje) 
    df
}
df_coah <- get_df(5, "coah")
df_mex <- get_df(15, "mex")
```

```{r, echo=FALSE, fig.width = 8, eval = TRUE}
plotDF_edo <- function(df, edo_nombre){
  ggplot(df, aes(fecha, median)) +
    geom_line(aes(group = candidato)) +
    geom_ribbon(aes(ymin = inf, ymax = sup, fill = candidato)) +
    facet_wrap(~method) +
    xlab("Hora") +
    ylab("Porcentaje") +
    labs(subtitle = paste("Votacion para gobernador de", edo_nombre)) +
    theme(legend.position="bottom")
}

plotDF_edo(df_coah, "Coahuila")
plotDF_edo(df_mex, "Mexico")
```



